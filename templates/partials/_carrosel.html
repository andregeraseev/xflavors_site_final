{% load static %}


<!-- Carregar CSS do Slick Carousel -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.min.css" />
<!-- Carregar JavaScript do Slick Carousel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js"></script>
<!-- Container principal -->




<div class="container my-5">
  <!-- Título -->
  <h3 class="text-center mb-3">Produtos mais vendidos</h3>
  <!-- Carrossel -->
  <div class="card-deck  slick-list ">
{% for product in products %}
  <div class="col mb-4 product-card ">
    <div class="card h-100 ">
      <a href="{% url 'product_detail' product.slug %}">
            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="card-img-top">
          </a>
      <div class="card-body">
        <a href="{% url 'product_detail' product.slug %}"><h5 class="card-title">{{ product.name }}</h5></a>
        {% if product.variation_set.exists %}
              <select name="variation" class="variation-select form-select form-control-sm w-100" data-product-id="{{ product.id }}" >
                {% for variation in product.variation_set.all %}
                  <option value="{{ variation.id }}">{{ variation.name }} - R$ {{ variation.price }}</option>
                {% endfor %}
              </select>
              <p class="mb-1" id="price{{ product.id }}">R$ {{ product.variation_set.first.price }}</p>
            {% else %}
              <p class="mb-1">{{ product.price }}</p>
            {% endif %}

          <div class="d-flex align-items-center add-to-cart-form ">
              <button type="submit" class="btn btn-primary btn-sm w-75 add-to-cart-button" data-product-id="{{ product.id }}" data-variation-id="">Adicionar ao carrinho</button>
              <input type="number" class="form-control form-control-sm mr-2 w-25 quantity-input " data-product-id="{{ product.id }}" value="1" min="1" max="{{ product.stock_available }}">
            </div>

      </div>
    </div>
  </div>
{% endfor %}






  </div>

</div>



<!-- Estilo CSS para o Slick Carousel -->
<style>


  /* Definir largura máxima da lista (container) do carrossel */
  .slick-list {
	max-width: 1200px;
	margin: 0 auto; /* centralizar o container na tela */
	padding: 30px 15px; /* adicionar padding em cima e em baixo */
  }

  /* Estilo para cada slide do carrossel */
  .slick-list .slick-slide {
	font-size: 20px; /* tamanho da fonte */
	text-align: center; /* centralizar o texto */
	padding: 20px 20px; /* adicionar padding à esquerda e à direita */
	line-height: 2; /* altura da linha */
	font-weight: 700; /* peso da fonte */
  }

  /* Estilo para slides ímpares */
  .slick-list .slick-slide:nth-child(odd) {

  }

  /* Estilo para as setas de navegação */
  .slick-arrow {
	z-index: 1; /* definir camada */
	width: 69px; /* largura */
	height: 30px; /* altura */

  }

  /* Estilo para o ícone dentro das setas */
  .slick-arrow:before {
	font-size: 50px; /* tamanho da fonte */
	color: #000000; /* cor */


  }

  /* Posicionamento da seta "próximo" */
  .slick-next {
	right: -7px; /* posicionar à direita */
  }

  /* Posicionamento da seta "anterior" */
  .slick-prev {
	left: -7px; /* posicionar à esquerda */
  }
.product-card {
  height: 470px; /* altura fixa para o card */
}

@media (max-width: 600px) {
  .product-card {
    height: 480px;
  }
}

</style>








<script>
$(document).ready(function() {
  // Seleciona todos os elementos com a classe "variation-select" e adiciona um listener a eles
  $('.variation-select').change(function() {
    let productId = $(this).data('product-id');
    let selectedVariationId = $(this).val();
    let selectedVariationPrice = $(this).find('option:selected').text().split(' - R$ ')[1];

    console.log('productId:', productId);
    console.log('selectedVariationId:', selectedVariationId);
    console.log('selectedVariationPrice:', selectedVariationPrice);

    // Atualiza o preço exibido
    $('#price'+productId).text('R$ ' + selectedVariationPrice);

    // Define o ID da variação selecionada no botão "Adicionar ao carrinho"
    $('.add-to-cart-button[data-product-id=' + productId + ']').data('variation-id', selectedVariationId);
  }).trigger('change'); // Dispara o evento 'change' após a página ser carregada
});


// Associa a função abaixo ao evento "click" do botão "Adicionar ao carrinho"
$('.add-to-cart-button').click(function() {
  let productId = $(this).data('product-id');
  let variationId = $(this).data('variation-id');
  let quantity = $(this).siblings('.quantity-input').val();

  console.log('productId:', productId);
  console.log('variationId:', variationId);
  console.log('quantity:', quantity);

  // Envia uma requisição AJAX para adicionar o produto ao carrinho
  $.ajax({
    type: 'POST',
    url: '{% url "add_to_cart_carrocel" %}',
    data: {
      'productId': productId,
      'variation_id': variationId,
      'quantity': quantity,
      'csrfmiddlewaretoken': '{{ csrf_token }}'
    },
    dataType: 'json',
    success: function(data) {
      if (data.success) {
        // Recarrega o ícone do carrinho
        $('#cart-icon').load(document.URL + ' #cart-icon');

        // Exibe uma mensagem de sucesso
        $('#alert_success').show();
        $('#alert_container_success').show();
        $('#alert_success').html(data.produto_adicionado);

        // Oculta a mensagem de sucesso após 5 segundos
        setTimeout(function() {
          $('#alert_success').hide();
          $('#alert_container_success').hide();
        }, 5000);

        // Define o valor do input de quantidade para 1
        $('.quantity-input[data-product-id=' + productId + ']').val(1);
      } else {
        // Exibe uma mensagem de erro
        $('#available-stock').text(data.stock);
        $('#alert-erro').show();
        $('#alert-container-erro').show();
        $('#alert-erro').html(data.error);

        // Oculta a mensagem de erro após 5 segundos
        setTimeout(function() {
          $('#alert-erro').hide();
          $('#alert-container-erro').hide();
        }, 5000);

        // Define o valor do input de quantidade para 1
        $('.quantity-input[data-product-id=' + productId + ']').val(1);
      }
    },
    error: function(data) {
      alert('Ocorreu um erro ao adicionar o produto ao carrinho. Tente novamente mais tarde.');
    }
  });
});







// Seleciona o elemento com a classe 'slick-list' e aplica o plugin slick()
  let slickList = $('.slick-list');
  slickList.slick({
    slidesToShow: 4,
    slidesToScroll: 1,
    arrows: true,
    infinite: true,
    autoplay: false,
    // Define a configuração do número de slides exibidos em diferentes tamanhos de tela
    responsive: [
      {
        breakpoint: 992,
        settings: {
          slidesToShow: 3
        }
      },
      {
        breakpoint: 576,
        settings: {
          slidesToShow: 1
        }
      }
    ]
  });

  // Seleciona os elementos com a classe 'prev-btn' e 'next-btn' e adiciona um listener para as ações de clique, que chama os métodos do plugin slick()
  let prevBtn = $('.prev-btn');
  let nextBtn = $('.next-btn');

  prevBtn.click(function() {
    slickList.slick('slickPrev');
  });

  nextBtn.click(function() {
    slickList.slick('slickNext');
  });

  // Adiciona um listener para o evento 'afterChange' do plugin slick() que define a classe 'slick-disabled' nos botões 'prev-btn' e 'next-btn' com base na posição do slide atual
  slickList.on('afterChange', function(event, slick, currentSlide) {
    prevBtn.toggleClass('slick-disabled', currentSlide === 0);
    nextBtn.toggleClass('slick-disabled', currentSlide === slick.slideCount - 1);
  });


</script>

