{% extends "base.html" %}

{% block content %}
<div class="container my-5">
    <h1 class="text-center">Carrinho</h1>
    <div id="container_carrinho">
        <table class="table table-striped">
            <thead>
            <tr>
                <th>Produto</th>
                <th>Preço</th>
                <th>Quantidade</th>
                <th>Total</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            {% for item in itens %}
            <tr>
                <td>{% if item.variation %} {{ item.variation.name }} {% else %} {{ item.product.name }} {% endif %}</td>
                <td>R$ {%if item.variation %} {{ item.variation.price }} {% else %} {{ item.product.price }} {% endif %}</td>

                <td>
                    <form>
                        <div class="d-flex justify-content-between align-items-center">
                            {% csrf_token %}
                            <input type="number" class="form-control form-control-sm  quantity"
                                   value="{{ item.quantity }}">
                            <a href="#" class="btn btn-primary btn-sm update-item"
                               data-product-id="{{ item.product.id }}" data-toggle="tooltip" title="Atualizar item">
                                <i class="fas fa-sync-alt"></i>
                            </a>
                        </div>
                    </form>
                </td>



                <td>
                    <a href="{% url 'cart:remove_item' %}" class="btn btn-danger btn-sm remove-item"
                       data-product-id="{{ item.product.id }}" data-variation-id="{{ item.variation.id }}"><i class="fas fa-trash"></i></a></a>
                </td>

            </tr>
            {% endfor %}
            </tbody>
            <tfoot>
            <tr>
                <td colspan="3"></td>
                <td>R$ {{ total }}</td>

                <td>
                    <a href="{% url 'cart:clear_cart' %}" class="btn btn-danger">Limpar carrinho</a>
                </td>
            </tr>
            </tfoot>
        </table>
        <div class="text-center">
            <a href="{% url 'home' %}" class="btn btn-primary">Continuar comprando</a>
            <a href="{% url 'checkout' %}" class="btn btn-success">Finalizar compra</a>
        </div>
    </div>
</div>
<script>
  $(document).ready(function() {
    $('.remove-item').click(function(e) {
      e.preventDefault();

      var variationId = $(this).data('variation-id');
      var productId = $(this).data('product-id');
      var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

      $.ajax({
        url: "{% url 'cart:remove_item' %}",
        type: 'POST',
        data: {
          'variation_id': variationId,
          'product_id': productId,
          'csrfmiddlewaretoken': csrfToken

        },
        success: function(data) {
          console.log(data);
          location.reload(); // recarrega a página quando a requisição é bem sucedida
        },
        error: function(error) {
          console.log(error);
          location.reload(); // recarrega a página quando a requisição falha
        }
      });
    });
  });
</script>


<script>
  $(document).ready(function() {
    $('.update-item').click(function(e) {
      e.preventDefault();

      var variationId = $(this).data('variation-id');
      var productId = $(this).data('product-id');
      var quantity = $(this).parent().parent().find('.quantity').val();
      var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

      $.ajax({
        url: "{% url 'cart:update_item' %}",
        type: 'POST',
        data: {
          'variation_id': variationId,
          'product_id': productId,
          'quantity': quantity,
          'csrfmiddlewaretoken': csrfToken
        },
        success: function(data) {
          console.log(data);
          location.reload(); // recarrega a página quando a requisição é bem sucedida
        },
        error: function(error) {
          console.log(error);
          location.reload(); // recarrega a página quando a requisição falha
        }
      });
    });
  });
</script>


{% endblock %}
